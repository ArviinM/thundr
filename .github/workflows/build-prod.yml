---
   name: Build the App on Production Environment
   run-name: ${{ github.actor }} is Triggering Production Build ðŸš€
   on:
     push:
       branches:
         - production-build
   env:
     BUILD_NAME: 1.0.0
     BUILD_NUMBER: ${{github.run_number}}
     APP_NAME: Thundr
     APP_ID: ph.thundr.app
   jobs:
     Git-Fetch-State:
       runs-on: macOS
       steps:        
         - run: rm -rf ${{ github.workspace }}/*
         - name: Check out repository code
           uses: actions/checkout@v4
           with:
            fetch-depth: 0
         - run: echo "${{ github.event.head_commit.message }}"
     Package-Rename:
       runs-on: macOS
       needs: Git-Fetch-State
       steps:
         - run: ls
         - run: react-native-rename "${{ENV.APP_NAME}}" -b "${{ENV.APP_ID}}"
         - run: echo -en "${{VARS.PROD_ENV}}" >> .env
         - run: echo "BUILD_NUMBER=${{github.run_number}}" >> .env
         - run: more .env
     Yarn-Install:
       runs-on: macOS
       needs: Package-Rename
       steps:
         - run: yarn install
         - run: ls
     Android-Prepare-Build:
       runs-on: macOS
       needs: Yarn-Install
       defaults:
         run:
           working-directory: ./android
       steps:
         - run: ls
         - run: echo "MYAPP_RELEASE_STORE_FILE=${{secrets.KEYSTORE_PATH}}" >>
             gradle.properties
         - run: echo "MYAPP_RELEASE_STORE_PASSWORD=${{secrets.KEYSTORE_PASSWORD}}" >>
             gradle.properties
         - run: echo "MYAPP_RELEASE_KEY_ALIAS=${{secrets.KEY_ALIAS}}" >> gradle.properties
         - run: echo "MYAPP_RELEASE_KEY_PASSWORD=${{secrets.KEY_PASSWORD}}" >>
             gradle.properties
         - run: echo "BUILD_NUMBER=${{ENV.BUILD_NUMBER}}" >> gradle.properties
         - run: echo "BUILD_NAME=${{ENV.BUILD_NAME}}" >> gradle.properties
         - run: echo "PLAY_PUBLISH_KEY_JSON=${{secrets.PLAYSTORE_JSON_KEY}}" >>
             gradle.properties
         - run: echo "PLAY_PUBLISH_TRACK=internal" >> gradle.properties
         - run: echo "RELEASE_NAME=Release ${{ENV.BUILD_NUMBER}}" >> gradle.properties
         - run: more gradle.properties
         - run: ls app
         - run: ./gradlew clean
     Android-APK-Build:
       runs-on: macOS
       needs: Android-Prepare-Build
       defaults:
         run:
           working-directory: ./android
       steps:
         - run: ls
         - run: ./gradlew assembleRelease
     Android-APK-Upload:
       runs-on: macOS
       needs: Android-APK-Build
       continue-on-error: true
       defaults:
         run:
           working-directory: ./android/app/build/outputs/apk/release
       steps:
         - run: ls
         - run: cp app-release.apk "thundr-prod-${{ github.run_number }}.apk"
         - run: cp "thundr-prod-${{ github.run_number }}.apk" /Users/bryllebarbosa/Desktop/Jorge/artifacts/
         - run: cp "thundr-prod-${{ github.run_number }}.apk" "/Users/bryllebarbosa/Google Drive/My Drive/Shared Folder/Android Production Upload"
     Android-AAB-Build:
       runs-on: macOS
       needs: Android-Prepare-Build
       defaults:
         run:
           working-directory: ./android
       steps:
         - run: ls
         - run: ./gradlew bundleRelease
     Android-AAB-Upload:
       runs-on: macOS
       needs: Android-AAB-Build
       continue-on-error: true
       defaults:
         run:
           working-directory: ./android/app/build/outputs/bundle/release
       steps:
         - run: ls
         - run: cp app-release.aab "thundr-prod-${{ github.run_number }}.aab"
         - run: cp "thundr-prod-${{ github.run_number }}.aab" /Users/bryllebarbosa/Desktop/Jorge/artifacts/
         - run: cp "thundr-prod-${{ github.run_number }}.aab" "/Users/bryllebarbosa/Google Drive/My Drive/Shared Folder/Android Production Upload"
     Android-Publish-Prod-PlayStore:
       runs-on: macOS
       needs: Android-AAB-Upload
       defaults:
         run:
           working-directory: ./android
       steps:
         - run: ls
         - run: ./gradlew publishBundle  --release-status draft
     iOS-Prepare-Build:
       runs-on: macOS
       needs: Yarn-Install
       steps:
         - run: ls
         - run: npx pod-install
         - run: npx react-native bundle --entry-file='index.js'
             --bundle-output='./ios/main.jsbundle' --dev=false --platform='ios'
             --assets-dest ios
         - run: /usr/libexec/Plistbuddy -c "Set CFBundleVersion ${{ENV.BUILD_NUMBER}}"
             "ios/"${{env.APP_NAME}}"/Info.plist"
         - run: /usr/libexec/Plistbuddy -c "Set CFBundleShortVersionString
             ${{ENV.BUILD_NAME}}" "ios/${{ENV.APP_NAME}}/Info.plist"
     iOS-Build:
       runs-on: macOS
       needs: iOS-Prepare-Build
       steps:
         - run: ls
         - run: ls ios
         - run: xcodebuild -list -workspace "ios/${{ENV.APP_NAME}}.xcworkspace"
         - run: echo "${{vars.DEV_EXPORT_OPTIONS_PLIST}}" >> exportOptions.plist
         - run: echo "${{vars.DEV_EXPORT_OPTIONS_PLIST_IPA}}" >> exportOptionsIPA.plist
         - run: xcodebuild archive -scheme "Thundr" -workspace
             "ios/${{ENV.APP_NAME}}.xcworkspace" -configuration Release
             -archivePath myArch -destination 'generic/platform=iOS'
             -allowProvisioningUpdates
     iOS-Export-IPA:
      runs-on: macOS
      needs: iOS-Build
      continue-on-error: true
      steps:
      - run: ls
      - run: xcodebuild -exportArchive -archivePath myArch.xcarchive -exportPath MyApp -exportOptionsPlist exportOptionsIPA.plist     
      - run: ls MyApp
      - run: cp "MyApp/${{ENV.APP_NAME}}.ipa" "thundr-prod-${{ github.run_number }}.ipa"
      - run: cp "thundr-prod-${{ github.run_number }}.ipa" /Users/bryllebarbosa/Desktop/Jorge/artifacts/
      - run: cp "thundr-prod-${{ github.run_number }}.ipa" "/Users/bryllebarbosa/Google Drive/My Drive/Shared Folder/Apple Production Upload"
     iOS-Export-AppStore:
      runs-on: macOS
      needs: iOS-Export-IPA
      steps:
      - run: ls
      - run: ls ios      
      - run: xcodebuild -exportArchive -archivePath myArch.xcarchive -exportPath MyApp -exportOptionsPlist exportOptions.plist
   concurrency:
     group: thundr-mobile
     cancel-in-progress: false
  
