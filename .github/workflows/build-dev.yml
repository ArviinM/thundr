name: Build the App on Dev Environment
run-name: ${{ github.actor }} is Triggering Develop Build ðŸš€
on: 
  push:
    branches:
    - develop-build
jobs:
  Git-Fetch-State:
    runs-on: self-hosted
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - run: echo "${{ github.event.head_commit.message }}"
  Yarn-Install:
        runs-on: self-hosted
        needs: Git-Fetch-State
        steps:
            - run: yarn install
            - run: ls
  Android-Prepare-Build:
    runs-on: self-hosted
    needs: Yarn-Install
    defaults:
        run:            
            working-directory: ./android
    steps:
      - run: ls        
      - run: echo "MYAPP_RELEASE_STORE_FILE=${{secrets.KEYSTORE_PATH}}" >> gradle.properties
      - run: echo "MYAPP_RELEASE_STORE_PASSWORD=${{secrets.KEYSTORE_PASSWORD}}" >> gradle.properties
      - run: echo "MYAPP_RELEASE_KEY_ALIAS=thundrph${{secrets.KEY_ALIAS}}" >> gradle.properties
      - run: echo "MYAPP_RELEASE_KEY_PASSWORD=${{secrets.KEY_PASSWORD}}" >> gradle.properties
      - run: ./gradlew clean
  Android-Build:
    runs-on: self-hosted
    needs: Android-Prepare-Build
    defaults:
        run:            
            working-directory: ./android
    steps:
      - run: ls
      - run: ./gradlew assembleRelease
  Android-Upload:
    runs-on: self-hosted
    needs:  Android-Build
    defaults:
        run:            
            working-directory: ./android/app/build/outputs/apk/release
    steps:
      - run: ls
      - run: cp app-release.apk "thundr-dev-${{ github.run_number }}.apk"   
      - run: gdrive files upload "thundr-dev-${{  github.run_number }}.apk" --parent '${{secrets.DEV_APK_GOOGLE_REPO}}'
  iOS-Prepare-Build:
    runs-on: macos
    needs: Yarn-Install
    defaults:
        run:            
            working-directory: ./ios
    steps:
      - run: ls
      - run: pod install
  iOS-Build:
        runs-on: macos
        needs: iOS-Prepare-Build
        steps:
        - run: ls
        - run: npx react-native bundle --entry-file='index.js' --bundle-output='./ios/main.jsbundle' --dev=false --platform='ios' --assets-dest ios
        - run: xcodebuild archive -scheme "Thundr" -workspace "ios/Thundr.xcworkspace" -configuration Release -archivePath myArch -allowProvisioningUpdates 
  iOS-Upload:
        runs-on: macos
        needs: iOS-Build
        defaults:
            run:            
                working-directory: ./ios
        steps:
            - run: ls
            - run: xcodebuild -exportArchive -archivePath myArch.xcarchive -exportPath MyApp -exportOptionsPlist exportOptions.plist
concurrency:
  group: default
  cancel-in-progress: true

                        